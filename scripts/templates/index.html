<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Transcriptions</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Left: Falling Transcriptions -->
        <div class="left">
            <div class="left-header">LLUM 2025</div>
            <div id="transcriptions">
                <div class="loading" id="loading">Loading...</div>
                <ul id="transcription-list">
                    <li>Test Transcription (In Progress)</li>
                    <li class="finished">Test Transcription (Finished)</li>
                </ul>
                
            </div>
        </div>
        
        <!-- Right: Responsive Image -->
        <div class="right">
            <img src="/static/Generated_Images/loading_animation2.gif" alt="Generated Image" id="image">
        </div>        
    </div>

    <!-- JavaScript for WebSocket -->
    <script>
        const ws = new WebSocket("ws://127.0.0.1:8001/ws");
        const transcriptionList = document.getElementById("transcription-list");
        const imageElement = document.getElementById("image");
        const loadingIndicator = document.getElementById("loading");

        const MAX_SENTENCES = 6; // Display 3 in-progress and 3 finished
        const DEFAULT_GIF = "/static/Generated_Images/loading_animation2.gif";
        const IMAGE_TIMEOUT = 30000; // Reset image after 30 seconds
        let imageTimeout = null;

        function updateTranscriptions(sentences) {
            const transcriptionList = document.getElementById("transcription-list");
            transcriptionList.innerHTML = ""; // Clear the current list

            sentences.forEach((sentence) => {
                const sentenceElement = document.createElement("li");
                sentenceElement.textContent = sentence.text;
                if (sentence.status === "done") {
                    sentenceElement.classList.add("done");
                } else {
                    sentenceElement.classList.add("in-progress");
                }
                transcriptionList.appendChild(sentenceElement);
            });
        }

        function connectWebSocket() {
            ws = new WebSocket("ws://127.0.0.1:8001/ws");

            ws.onopen = () => {
                console.log("WebSocket connection established.");
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.event === "update_sentences") {
                    console.log("Updated sentences received:", message.data);
                    updateTranscriptions(message.data); // Update the UI dynamically
                } else if (message.event === "update_image") {
                    console.log("Image path received:", message.data);
                    updateImage(message.data); // Function to update the image dynamically
                }
            };

            ws.onclose = (event) => {
                console.warn("WebSocket connection closed:", event);
                console.log("Reconnecting in 2 seconds...");
                setTimeout(connectWebSocket, 2000); // Reconnect after 2 seconds
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        }

        // Update displayed image
        function updateImage(imagePath) {
            const imageElement = document.getElementById("image");
            imageElement.src = `${imagePath}?t=${new Date().getTime()}`; // Cache-busting
        }

        // WebSocket connection open
        ws.onopen = () => {
            console.log("WebSocket connection established.");
            loadingIndicator.style.display = "none";
        };

        function addSentence(sentence) {
            const transcriptionList = document.getElementById("transcription-list");
            const newSentence = document.createElement("li");
            newSentence.textContent = sentence.text;

            if (sentence.status === "done") {
                newSentence.classList.add("finished");
            } else if (sentence.status === "new") {
                newSentence.classList.add("in-progress");
            }

            transcriptionList.insertBefore(newSentence, transcriptionList.firstChild);

            // Remove excess sentences if more than 6
            while (transcriptionList.children.length > 6) {
                transcriptionList.removeChild(transcriptionList.lastChild);
            }
        }

        // Handle incoming WebSocket messages
        ws.onmessage = (event) => {
            console.log("WebSocket message received:", event.data);
            try {
                const message = JSON.parse(event.data);

                if (message.event === "ping") {
                    console.log("Received ping from server."); // Ignore pings
                    return;
                }

                if (message.event === "init_sentences" && message.data) {
                    console.log("Initializing sentences:", message.data);
                    updateTranscriptions(message.data);
                }

                if (message.event === "update_sentences") {
                    console.log("Updating transcriptions:", message.data); // Debug log
                    updateTranscriptions(message.data);
                }

                if (message.event === "update_image" && message.data) {
                    const imagePath = message.data.image_path;
                    console.log("Image update received:", imagePath);
                    imageElement.src = `${imagePath}?t=${new Date().getTime()}`; // Add timestamp to bypass cache
                }
            } catch (error) {
                console.error("Error processing WebSocket message:", error);
            }
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        ws.onclose = () => {
            console.warn("WebSocket connection closed.");
        };
    </script>
</body>
</html>
