<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Transcriptions</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Right: Responsive Image -->
        <div class="middle">
            <img src="/static/Generated_Images/loading_animation2.gif" alt="Generated Image" id="image">
        </div> 
        <div class="right">
            <div class="left-header">
                <div class="question-spanish" id="question-spanish">
                    How will living in cities look like in the future ?
                </div>
                <div class="question-english" id="question-english">
                    How will living in cities look like in the future ? 
                </div> 
             </div>
             <div id="transcriptions">
                <div class="status-box" id="recording-box">
                    <div class="status-icon">
                        <img src="/static/Icons/sound.gif" alt="audio gif" style= "width:24px; height:24px;"></img>
                    </div>
                    <div class="status-text">recording</div>
                </div>
                
                <div class="status-box" id="transcribing-box">
                    <div class="status-icon">
                        <img src="/static/Icons/write.gif"alt="writing gif" style= "width:24px; height:24px;"></img>
                    </div>
                    <div class="status-text">transcribing</div>
                </div>  
                <div class="status-box" id="loading-box">
                    <div class="status-icon">
                        <img src="/static/Icons/loading.gif"alt="loading gif" style= "width:24px; height:24px;"></img>
                    </div>
                    <div class="status-text">processing</div>
                </div>                
                <div id="in-progress-box">
                    <div id="in-progress-list"></div>
                    <div class="processing-header">
                        <div class="status-icon" id="processing-icon">
                            <img src="/static/Icons/counter.gif" alt="loading gif" id="processing-icon" style= "width:24px; height:24px;"></img>
                        </div>
                        <div class="status-text" id="processing-text">collecting</div>
                    </div>
                </div>
                <div id="done-box">
                    <div id="done-list"></div>
                    <div class="generated-header">
                        <div class="status-icon" id="done-icon">
                            <img src="/static/Icons/check.gif" alt="check gif" id="done-icon" style= "width:24px; height:24px;"></img>
                        </div>
                        <div class="status-text" id="done-text">image generated</div>
                    </div>
                </div>
                
            </div>
             
        </div> 
             
    </div>

    <!-- JavaScript for WebSocket -->
    <script>
        const ws = new WebSocket("ws://127.0.0.1:8001/ws");
        const transcriptionList = document.getElementById("transcription-list");
        const imageElement = document.getElementById("image");
        const loadingIndicator = document.getElementById("loading");

        const MAX_SENTENCES = 6; // Display 3 in-progress and 3 finished
        const DEFAULT_GIF = "/static/Generated_Images/loading_animation2.gif";
        const IMAGE_TIMEOUT = 30000; // Reset image after 30 seconds
        let imageTimeout = null;

        const questionElementEnglish = document.getElementById("question-english");
        const questionElementSpanish = document.getElementById("question-spanish");

        const questionsEnglish = [
            "How will living in cities look like in the future?", 
            "What will transportation look like in the future?",
            "How will AI impact daily life in urban areas?",
            "How will streets change in the future?",
            "What does the future smell like?",
            "What challenges do you see in the future?",
            "How can technology bridge gaps in city accessibility?",
            "How do you imagine the Urban Jungle?",
            "How will people travel in the future?",
            "How do you imagine public spaces in the future?",
            "How will Barcelona Streets look like in the future?",
            "How will children live like in the future?",
            "What will we eat in the future?",
            "How will animals live like in future cities?",
            "What will we see in the museum in the future?"
        ];

        const questionsSpanish = [
            "ow will living in cities look like in the future?", 
            "hat will transportation look like in the future?",
            "ow will AI impact daily life in urban areas?",
            "How will streets change in the future?",
            "What does the future smell like?",
            "What challenges do you see in the future?",
            "How can technology bridge gaps in city accessibility?",
            "How do you imagine the Urban Jungle?",
            "How will people travel in the future?",
            "How do you imagine public spaces in the future?",
            "How will Barcelona Streets look like in the future?",
            "How will children live like in the future?",
            "What will we eat in the future?",
            "How will animals live like in future cities?",
            "What will we see in the museum in the future?"
        ];

        let currentQuestionIndexEnglish = 0;
        let currentQuestionIndexSpanish = 0;
        
        function getCurrentQuestionEnglish() {
        return questionsEnglish[currentQuestionIndexEnglish];
        }

        function getCurrentQuestionSpanish() {
        return questionsSpanish[currentQuestionIndexSpanish];
        }


        // Update the question after an image is generated
        function updateQuestion() {
            currentQuestionIndexEnglish = (currentQuestionIndexEnglish + 1) % questionsEnglish.length;
            currentQuestionIndexSpanish = (currentQuestionIndexSpanish + 1) % questionsSpanish.length;
            const newQuestionEnglish = questionsEnglish[currentQuestionIndexEnglish];
            const newQuestionSpanish = questionsSpanish[currentQuestionIndexSpanish];
            questionElementEnglish.textContent = newQuestionEnglish;
            questionElementSpanish.textContent = newQuestionSpanish;
            updateQuestionWithTypewriterEnglish(newQuestionEnglish);
            updateQuestionWithTypewriterSpanish(newQuestionSpanish);

            // Send the updated question to the server
            ws.send(
                JSON.stringify({
                    event: "update_question",
                    english: newQuestionEnglish,
                    spanish: newQuestionSpanish
                })
            );
        }
        function updateQuestionWithTypewriterEnglish(newQuestionEnglish) {
            const questionElementEnglish = document.getElementById("question-english");

            questionElementEnglish.textContent = ""; // Clear current content

            let charIndex = 0;
            const typingInterval = setInterval(() => {
                if (charIndex < newQuestionEnglish.length) {
                    questionElementEnglish.textContent += newQuestionEnglish[charIndex];
                    charIndex++;
                } else {
                    clearInterval(typingInterval);
                }
            }, 100); // Typewriter speed (100ms per character)
        }
        function updateQuestionWithTypewriterSpanish(newQuestionSpanish) {
            const questionElementSpanish = document.getElementById("question-spanish");

            questionElementSpanish.textContent = ""; // Clear current content

            let charIndex = 0;
            const typingInterval = setInterval(() => {
                if (charIndex < newQuestionSpanish.length) {
                    questionElementSpanish.textContent += newQuestionSpanish[charIndex];
                    charIndex++;
                } else {
                    clearInterval(typingInterval);
                }
            }, 100); // Typewriter speed (100ms per character)
        }
        // Helper functions
        function fadeIn(element) {
            element.style.opacity = 0;
            element.style.display = "block";
            setTimeout(() => {
                element.style.transition = "opacity 0.5s";
                element.style.opacity = 1;
            }, 10);
        }

        function fadeOut(element) {
            element.style.transition = "opacity 0.5s";
            element.style.opacity = 0;
            setTimeout(() => {
                element.style.display = "none";
            }, 500); // Match the transition duration
        }

        function updateImageWithDissolve(newImagePath) {
            const imageElement = document.getElementById("image");

            fadeOut(imageElement);

            setTimeout(() => {
                imageElement.src = `${newImagePath}?t=${new Date().getTime()}`;
                fadeIn(imageElement);
            }, 500); // Match fade-out duration
        }
        function updateTranscriptions(sentences) {
            // Clear existing lists
            const inProgressList = document.getElementById("in-progress-list");
            const doneList = document.getElementById("done-list");
            const inProgressBox = document.getElementById("in-progress-box");
            const doneBox = document.getElementById("done-box");
            // Clear and fade-out old content
            fadeOut(inProgressList);
            fadeOut(doneList);

            setTimeout(() => {

                inProgressList.innerHTML = "";
                doneList.innerHTML = "";

                let hasInProgress = false;
                let hasDone = false;

                // Iterate through sentences and append to their respective lists
                sentences.forEach((sentence) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = sentence.text;

                    if (sentence.status === "in-progress") {
                        hasInProgress = true;
                        listItem.classList.add("in-progress");
                        inProgressList.appendChild(listItem);
                    } else if (sentence.status === "done") {
                        hasDone = true;
                        listItem.classList.add("done");
                        doneList.appendChild(listItem);
                    }
                });
                // Fade-in new content
                fadeIn(inProgressList);
                fadeIn(doneList);
            }, 500); // Match fade-out duration

            // Toggle visibility based on content
            inProgressBox.style.display = hasInProgress ? "block" : "none";
            doneBox.style.display = hasDone ? "block" : "none";
        }

        function connectWebSocket() {
            ws = new WebSocket("ws://127.0.0.1:8001/ws");

            ws.onopen = () => {
                console.log("WebSocket connection established.");
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);

                    if (message.event === "update_sentences" && message.data) {
                        console.log("Updating transcriptions:", message.data);
                        updateTranscriptions(message.data);
                    }

                    if (message.event === "current_question" && message.data) {
                        questionElementEnglish.textContent = message.data.question-english;
                    }

                    if (message.event === "update_image" && message.data) {
                        const imagePath = message.data.image_path;
                        console.log("Image update received:", imagePath);
                        updateImageWithDissolve(imagePath);
                        // imageElement.src = `${imagePath.replace(/\\/g, "/")}?t=${new Date().getTime()}`;
                        updateQuestion()
                    }

                    if (message.event === "state_update") {
                        // Handle recording, transcribing, and processing states
                        const state = message.data.state;
                        const recordingBox = document.getElementById("recording-box");
                        const transcribingBox = document.getElementById("transcribing-box");
                        const inProgressBox = document.getElementById("in-progress-box");
                        const loadingBox = document.getElementById("loading-box");
                        const doneBox = document.getElementById("done-box");
                        const processingText = document.getElementById("processing-text");
                        const processingIcon = document.getElementById("processing-icon img");
                        const doneText = document.getElementById("status-text");
                        const doneIcon = document.getElementById("status-icon img");
                        

                        console.log(`Updating state to: ${state}`); // Debugging log

                        // Reset visibility for all boxes
                        // Reset visibility for all boxes
                        recordingBox.style.display = "none";
                        transcribingBox.style.display = "none";
                        doneBox.style.display = "none";
                        loadingBox.style.display = "none";
                        inProgressBox.classList.remove("processing");
                        
                        // Handle recording state
                        if (state === "recording") {
                            recordingBox.classList.add("visible");
                            // inProgressBox.classList.remove("processing");
                            // processingText.textContent = "collecting";
                            processingIcon.src = "/static/Icons/counter.gif";
                        }
                        // Handle transcribing state
                        else if (state === "transcribing") {
                            recordingBox.classList.add("visible");
                            // inProgressBox.classList.remove("processing");
                            // processingText.textContent = "collecting";
                            processingIcon.src = "/static/Icons/writing.gif";
                        }
                        // Handle idle state
                        else if (state === "idle") {
                            recordingBox.style.visibility = "hidden";
                            transcribingBox.style.visibility = "hidden";
                            // inProgressBox.classList.remove("processing");
                            processingText.textContent = "collecting";
                            processingIcon.src = "/static/Icons/loading.gif";
                        }
                        // Handle image processing state
                        else if (state === "image_processing") {
                            inProgressBox.classList.add(".processing");
                            processingText.textContent = "generating";
                            processingIcon.src = "/static/Icons/loading.gif";
                            loadingBox.style.visibility.add("visible");
                        }  else if (state === "image_generated") {
                            doneBox.classList.add("visible");
                            doneText.textContent = "image generated";
                            doneIcon.src = "/static/Icons/upload.gif"; // Set back to "check" icon
                        }  else if (state === "image_saved") {
                            recordingBox.style.visibility = "hidden";
                            transcribingBox.style.visibility = "hidden";
                            doneText.textContent = "image saved";
                            doneIcon.src = "/static/Icons/check.gif"; // Set back to "check" icon
                        }
                        // Fallback for unknown states
                        else {
                            console.warn(`Unknown state: ${state}`);
                            inProgressBox.classList.remove("processing");
                            processingText.textContent = "no state";
                            processingIcon.src = "/static/Icons/loading.gif";
                        }
                    }

                } catch (error) {
                    console.error("Error processing WebSocket message:", error);
                }       
            };
            ws.onclose = (event) => {
                    console.warn("WebSocket connection closed. Reconnecting in 5 seconds...", event);
                    setTimeout(connectWebSocket, 5000); // Reconnect after 5 seconds
            };
        }

        // Update displayed image
        function updateImage(imagePath) {
            const imageElement = document.getElementById("image");
            imageElement.src = `${imagePath}?t=${new Date().getTime()}`; // Cache-busting
        }

        // WebSocket connection open
        ws.onopen = () => {
            console.log("WebSocket connection established.");
            loadingIndicator.style.display = "none";
        };

        function addSentence(sentence) {
            const transcriptionList = document.getElementById("transcription-list");
            const newSentence = document.createElement("li");
            newSentence.textContent = sentence.text;

            if (sentence.status === "done") {
                newSentence.classList.add("finished");
            } else if (sentence.status === "new") {
                newSentence.classList.add("in-progress");
            }

            transcriptionList.insertBefore(newSentence, transcriptionList.firstChild);

            // Remove excess sentences if more than 6
            while (transcriptionList.children.length > 6) {
                transcriptionList.removeChild(transcriptionList.lastChild);
            }
        }

        // Handle incoming WebSocket messages
        ws.onmessage = (event) => {
            console.log("WebSocket message received:", event.data);
            try {
                const message = JSON.parse(event.data);
                if (message.event === "state_update") {
                    // Handle recording and transcribing states
                    const state = message.data.state;
                    const recordingBox = document.getElementById("recording-box");
                    const transcribingBox = document.getElementById("transcribing-box");
                    if (state === "recording") {
                        recordingBox.style.display = "block";
                        transcribingBox.style.display = "none";
                        loadingBox.stzle.display ="none"
                    } else if (state === "transcribing") {
                        recordingBox.style.display = "none";
                        transcribingBox.style.display = "block";
                        loadingBox.stzle.display ="none"
                    } else if (state === "idle") {
                        recordingBox.style.display = "none";
                        transcribingBox.style.display = "none";
                        loadingBox.stzle.display ="none"
                    } 
                    else if (state === "image_processing") {
                        // inProgressBox.classList.add(".processing");
                        // processingText.textContent = "generating";
                        // processingIcon.src = "/static/Icons/loading.gif";
                        recordingBox.style.display = "none";
                        transcribingBox.style.display = "none";
                        loadingBox.stzle.display ="block"
                    }  else if (state === "image_generated") {
                        doneBox.classList.add("visible");
                        doneText.textContent = "image generated";
                        doneIcon.src = "/static/Icons/upload.gif"; // Set back to "check" icon
                    }  else if (state === "image_saved") {
                        recordingBox.style.visibility = "hidden";
                        transcribingBox.style.visibility = "hidden";
                        doneText.textContent = "image saved";
                        doneIcon.src = "/static/Icons/check.gif"; // Set back to "check" icon
                    }

                } else if (message.event === "ping") {
                    console.log("Received ping from server."); // Ignore pings
                    return;
                } else if (message.event === "current_question") {
                    console.log("Server requested current question");
                    ws.send(
                        JSON.stringify({
                            event: "current_question",
                            data: getCurrentQuestionEnglish() || "How will living in cities look like in the future ?",
                        })
                    );
                } else if (message.event === "init_sentences" && message.data) {
                    console.log("Initializing sentences:", message.data);
                    updateTranscriptions(message.data);

                } else if (message.event === "update_sentences") {
                    console.log("Updating transcriptions:", message.data); // Debug log
                    updateTranscriptions(message.data);

                } else if (message.event === "update_image" && message.data) {
                    const imagePath = message.data.image_path;
                    console.log("Image update received:", imagePath);
                    imageElement.src = `${imagePath}?t=${new Date().getTime()}`; // Add timestamp to bypass cache
                    updateQuestion(); // Update the question after the image is updated
                } 
            } catch (error) {
                console.error("Error processing WebSocket message:", error);
            }
        };

        

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        ws.onclose = () => {
            console.warn("WebSocket connection closed.");
        };
    </script>
</body>
</html>
