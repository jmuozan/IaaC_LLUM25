<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Transcriptions</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Left: Falling Transcriptions -->
        <div class="left">
            <div class="left-header">Miralls de Manana - LLUM 2025</div>
            <div id="transcriptions">
                <div id="in-progress-box" class="status-box">
                    <div id="in-progress-list"></div>
                    <div class="processing-header">Processing</div>
                </div>
                <div id="done-box" class="status-box">
                    <div id="done-list"></div>
                    <div class="generated-header">Vision Generated</div>
                </div>
                
            </div>
        </div>
        <!-- Right: Responsive Image -->
        <div class="right">
            <img src="/static/Generated_Images/loading_animation2.gif" alt="Generated Image" id="image">
        </div>  
        <div class="question" id="question">
            How will living in cities look like in the future ?
        </div>      
    </div>

    <!-- JavaScript for WebSocket -->
    <script>
        const ws = new WebSocket("ws://127.0.0.1:8001/ws");
        const transcriptionList = document.getElementById("transcription-list");
        const imageElement = document.getElementById("image");
        const loadingIndicator = document.getElementById("loading");

        const MAX_SENTENCES = 6; // Display 3 in-progress and 3 finished
        const DEFAULT_GIF = "/static/Generated_Images/loading_animation2.gif";
        const IMAGE_TIMEOUT = 30000; // Reset image after 30 seconds
        let imageTimeout = null;

        const questionElement = document.getElementById("question");

        const questions = [
            "How will living in cities look like in the future?",
            "What will transportation look like in the future?",
            "How will AI impact daily life in urban areas?",
            "How will streets change in the future?",
            "What does the future smell like?",
            "What challenges do you see in the future?",
            "How can technology bridge gaps in city accessibility?",
            "How do you imagine the Urban Jungle?",
            "How will people travel in the future?",
            "How do you imagine public spaces in the future?",
            "How will Barcelona Streets look like in the future?",
            "How will children live like in the future?",
            "What will we eat in the future?",
            "How will animals live like in future cities?",
            "What will we see in the museum in the future?"
        ];

        let currentQuestionIndex = 0;
        
        function getCurrentQuestion() {
        return questions[currentQuestionIndex];
        }


        // Update the question after an image is generated
        function updateQuestion() {
            currentQuestionIndex = (currentQuestionIndex + 1) % questions.length;
            const newQuestion = questions[currentQuestionIndex];
            questionElement.textContent = newQuestion;

            // Send the updated question to the server
            ws.send(
                JSON.stringify({
                    event: "update_question",
                    data: newQuestion,
                })
            );
        }


        function updateTranscriptions(sentences) {
            // Clear existing lists
            const inProgressList = document.getElementById("in-progress-list");
            const doneList = document.getElementById("done-list");
            inProgressList.innerHTML = "";
            doneList.innerHTML = "";

            // Iterate through sentences and append to their respective lists
            sentences.forEach((sentence) => {
                const listItem = document.createElement("li");
                listItem.textContent = sentence.text;

                if (sentence.status === "in-progress") {
                    listItem.classList.add("in-progress");
                    inProgressList.appendChild(listItem);
                } else if (sentence.status === "done") {
                    listItem.classList.add("done");
                    doneList.appendChild(listItem);
                }
            });
        }

        function connectWebSocket() {
            ws = new WebSocket("ws://127.0.0.1:8001/ws");

            ws.onopen = () => {
                console.log("WebSocket connection established.");
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);

                    if (message.event === "update_sentences" && message.data) {
                        console.log("Updating transcriptions:", message.data);
                        updateTranscriptions(message.data);
                    }

                    if (message.event === "current_question" && message.data) {
                        questionElement.textContent = message.data.question;
                    }

                    if (message.event === "update_image" && message.data) {
                        const imagePath = message.data.image_path;
                        console.log("Image update received:", imagePath);
                        imageElement.src = `${imagePath.replace(/\\/g, "/")}?t=${new Date().getTime()}`;
                        updateQuestion()
                    }
                } catch (error) {
                    console.error("Error processing WebSocket message:", error);
                }
            };
            ws.onclose = (event) => {
                    console.warn("WebSocket connection closed. Reconnecting in 5 seconds...", event);
                    setTimeout(connectWebSocket, 5000); // Reconnect after 5 seconds
            };
        }

        // Update displayed image
        function updateImage(imagePath) {
            const imageElement = document.getElementById("image");
            imageElement.src = `${imagePath}?t=${new Date().getTime()}`; // Cache-busting
        }

        // WebSocket connection open
        ws.onopen = () => {
            console.log("WebSocket connection established.");
            loadingIndicator.style.display = "none";
        };

        function addSentence(sentence) {
            const transcriptionList = document.getElementById("transcription-list");
            const newSentence = document.createElement("li");
            newSentence.textContent = sentence.text;

            if (sentence.status === "done") {
                newSentence.classList.add("finished");
            } else if (sentence.status === "new") {
                newSentence.classList.add("in-progress");
            }

            transcriptionList.insertBefore(newSentence, transcriptionList.firstChild);

            // Remove excess sentences if more than 6
            while (transcriptionList.children.length > 6) {
                transcriptionList.removeChild(transcriptionList.lastChild);
            }
        }

        // Handle incoming WebSocket messages
        ws.onmessage = (event) => {
            console.log("WebSocket message received:", event.data);
            try {
                const message = JSON.parse(event.data);

                if (message.event === "ping") {
                    console.log("Received ping from server."); // Ignore pings
                    return;
                }

                else if (message.event === "current_question") {
                    console.log("Server requested current question");
                    ws.send(
                        JSON.stringify({
                            event: "current_question",
                            data: getCurrentQuestion() || "How will living in cities look like in the future ?",
                        })
                    );

                } else if (message.event === "init_sentences" && message.data) {
                    console.log("Initializing sentences:", message.data);
                    updateTranscriptions(message.data);

                } else if (message.event === "update_sentences") {
                    console.log("Updating transcriptions:", message.data); // Debug log
                    updateTranscriptions(message.data);

                } else if (message.event === "update_image" && message.data) {
                    const imagePath = message.data.image_path;
                    console.log("Image update received:", imagePath);
                    imageElement.src = `${imagePath}?t=${new Date().getTime()}`; // Add timestamp to bypass cache
                    updateQuestion(); // Update the question after the image is updated
                }
            } catch (error) {
                console.error("Error processing WebSocket message:", error);
            }
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        ws.onclose = () => {
            console.warn("WebSocket connection closed.");
        };
    </script>
</body>
</html>
